# Engineer's Log

Similar to a Captian's log, this will contain my thoughts, learnings, and experiences.

Rationale: This is my first deep dive into k8s + helm to package and run applications. I am also learning to use ChatGPT to boost my productivity. There's a lot of learning going on, so I want to capture and share. This may be adapted to a blog post in the future.

### 2023-01-10

Project inception (give or take a few days)

Initially I wanted to make this a quick-and-easy example of low-code tooling for making a vinyl library + API/database integration. I had a few screening calls that wanted to see K8s experience, so I decided to branch out and use k8s with `kind` and `helm` for local development.

This ambition has been boosted by ChatGPT, which is enabling me to provide better documentation with much less effort; template files, etc.

I stood up & dockerized a `FastAPI` server in Python; this will eventually be used to integrate with ChatGPT to generate record descriptions.

The README is nearly entirely driven by ChatGPT with additional edits and sylistic changes. This file reflects my experience and learnings, and thus has not been generated by an AI (yet?).

Ok, getting into helm charts, and creating a k8s cluster.

- The cluster exists independently of the helm implementation
  - ~~TODO: write a script checking for kind cluster~~
- Learning to package helm charts.... this is a little more than I realized. Feeling a sense of humility. I thought my experience in Docker orchestration with Fargate & docker-compose would translate a little more directly. Back to K8s docs and building from the ground up.
- Ok this is interesting: `helm` charts simply configure k8s with a consistent format driven by Go templates. Much simpler than it looked from a distance.
- Continuing to learn about k8s and the `kubectl` commands. It's interesting, definitely elegant but rather complex.

While trying to follow the vanilla k8s instructions at [appsmith](https://docs.appsmith.com/getting-started/setup/installation-guides/kubernetes) I keep encountering an `ImagePullBackOff` error. I created a docker login to see if that will help. It didn't...

I ended up editing the `values.yml` file and updating it to only pull on command. This worked well, then I learned about `kubectl` port-forward and everything makes sense finally.

I got `appsmith` up and running; now I want to figure out how to extend the chart to add my own resources in k8s and then repackage that... Anyways, major progress on k8s today.

### 2023-01-11

I spent some time reading up on storage persistence on k8s. I don't quite grok it yet but I'm trying to be patient. How do I backup/persist volumes mapped to containers? It looks like k8s has a different abstraction. Sure enough, hitting the docs:

> Storage orchestration Kubernetes allows you to automatically mount a storage system of your choice, such as local storages, public cloud providers, and more.

[source](https://kubernetes.io/docs/concepts/overview/#why-you-need-kubernetes-and-what-can-it-do)

I asked ChatGPT and it looks like there's a k8s API for creating a configMap or secret. Learning a lot here.

To focus on getting an operational POC (before configuring persistent storage), I changed gears to get the `appsmith` install working via a local chart config.

I thought I would be able to build the container I want to serve locally, but it looks like there are some extra steps using [`kind`](https://kind.sigs.k8s.io/docs/user/local-registry/). Or I could use `kind load docker-image` [per this](https://kind.sigs.k8s.io/docs/user/quick-start/#loading-an-image-into-your-cluster). Since I only need to work with the one API image I think it will be easy enough to make a build & load script. This was a bit of a tangential learning curve, though!

I managed to get the API running via helm install with:

```
docker build -t low-code-vinyl-api vinyl_api
kind load docker-image low-code-vinyl-api --name low-code-vinyl
```

Then, I can run the helm charts against the cluster with:

```
helm install low-code-vinyl helm
kubectl port-forward "$(kubectl get pods --namespace default -l "app.kubernetes.io/name=low-code-vinyl,app.kubernetes.io/instance=low-code-vinyl" -o jsonpath="{.items[0].metadata.name}")" 8080:8000
```

I'm able to see that the API works when navigating to <http://localhost:8080>!

### 2023-01-12

I have `appsmith` added as a dependency to the API. It starts when I install my `low-code-vinyl` helm chart; however it does not initialize fully. I see Mongo and Redis are also being provisioned. Also, this is dumb but... the name getting generated for the low-code-vinyl pod looks like `low-code-vinyl-api-78657df7bb-94rcz` rather than `low-code-vinyl-api-0`. But we'll worry about that later. The `appsmith` issue:

    low-code-vinyl-appsmith-0          0/1     Init:0/2           0             21m

This of course leads to [init containers](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/). And look there's even an article on [Debug Init Containers](https://kubernetes.io/docs/tasks/debug/debug-application/debug-init-containers/).

I observe that `appsmith` uses a `statefulset` template rather than a `deployment` template. This led me to feel like I need a better grounding in the k8s documentation, again, to understand what a `deployment` vs a `statefulset` looks like and to better understand how Helm generates the configuration.

Thanks [k8s docs](https://kubernetes.io/docs/concepts/workloads/)!

>Kubernetes provides several built-in workload resources:
>
>- Deployment and ReplicaSet (replacing the legacy resource ReplicationController). Deployment is a good fit for managing a stateless application workload on your cluster, where any Pod in the Deployment is interchangeable and can be replaced if needed.
>- StatefulSet lets you run one or more related Pods that do track state somehow. For example, if your workload records data persistently, you can run a StatefulSet that matches each Pod with a PersistentVolume. Your code, running in the Pods for that StatefulSet, can replicate data to other Pods in the same StatefulSet to improve overall resilience.

I truly expected choosing k8s with Helm over `docker-compose` would only add a few hours to my project as I could adapt my deep knowledge of containerization to this paradigm. There's a lot that's not even passingly familiar; too many k8s-specific terms. I'm making progress and learning a lot though.

We want to change the helm-generated deployment.yml file with a StatefulSet. Also, re: the appsmith issue, it appears the pod may not have the right networking to the mongo and redis containers. I will need to look into that a little more if moving to a StatefulSet does not resolve the issue.

ChatGPT is amazing. I asked it to adapt the `deployment.yaml` template I had been implementing to a `statefulset.yaml`.

### 2023-01-13

Yesterday involved a lot of learning but I was not able to leverage that into the application yet. Today, I hope to focus a little more on implementation. I have a gripe about the K8s docs: They don't do a great job of building off of what you learn to teach what you need to  know. By this, I mean that the `Workloads` discusses `StatefulSets` but a `Service` is not introduced until a later section! The docs reference selector logic but do not provide links to what a selector is and why you care. The result is a perception that k8s is more difficult than it is, it's just presented in a way that takes a lot of cross referencing.

### 2023-01-19

Took some time to work on an intervie project since this one isn't at a sharable state.

Decided I want to use a `StatefulSet` and add a container for Appsmith to the statefulset; this will be of course the exposed service for the pod.

I feel like getting away from k8s actually helped solidify my understanding.

### 2023-01-20

Beginner's mindset. I am going to scrap most of what I've done and try again.

I want to create a `deployment` for my stateless api and a `statefulset` for my database/persistence.

[This](https://stackoverflow.com/a/48834453/4175701) helped clear things up for me a lot. The recommendation to look at the [prometheus](https://github.com/helm/charts/tree/master/stable/prometheus) helm chart config worked well.

Remaining questions?

- Add `appsmith` to the `Chart.yaml` dependencies?

    I think this is the way to go... I could add templates but I don't need to customize it. I think I've learned enough now to figure out the right overrides for Mongo DB and Redis (the way I installed it before did not resolve and kept `appsmith` from starting)
